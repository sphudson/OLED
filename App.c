
/*! 
 *  Copyright (c) 2012, Stanford P. Hudson, All Rights Reserved
 *
 *  @file App.c
 *  @brief Application module
*/

#include <msp430f2013.h>
#include "System.h"
#include "Common.h"

/*
OLED - MSP430 connections:

CS   - P2 (P1.0)
RST  - P3 (P1.1)
D/C  - P4 (P1.2)
CLK  - P7 (P1.5)
DATA - P8 (P1.6)
VIN  - P1 
3.3V - P1
GND  - P14

*/

#define MAX_ROWS  (4)
#define MAX_COLS  (21)

enum
{
  SETCONTRAST = 0x81,
  DISPLAYALLON_RESUME = 0xA4,
  DISPLAYALLON = 0xA5,
  NORMALDISPLAY = 0xA6,
  INVERTDISPLAY = 0xA7,
  DISPLAYOFF = 0xAE,
  DISPLAYON = 0xAF,
  SETDISPLAYOFFSET = 0xD3,
  SETCOMPINS = 0xDA,
  SETVCOMDETECT = 0xDB,
  SETDISPLAYCLOCKDIV = 0xD5,
  SETPRECHARGE = 0xD9,
  SETMULTIPLEX = 0xA8,
  SETLOWCOLUMN = 0x00,
  SETHIGHCOLUMN = 0x10,
  SETSTARTLINE = 0x40,
  MEMORYMODE = 0x20,
  COMSCANINC = 0xC0,
  COMSCANDEC = 0xC8,
  SEGREMAP = 0xA0,
  CHARGEPUMP = 0x8D,
  SETCOLUMNADDR = 0x21,
  SETPAGEADDR = 0x22
};

#define CS_LOW()   (P1OUT &= ~BIT0)
#define CS_HIGH()  (P1OUT |= BIT0)
#define RST_LOW()  (P1OUT &= ~BIT1)
#define RST_HIGH() (P1OUT |= BIT1)
#define DC_LOW()   (P1OUT &= ~BIT2)
#define DC_HIGH()  (P1OUT |= BIT2)

static void WriteData(u8_t dataByte);
static void WriteCommand(u8_t dataByte);
static void WriteByte(u8_t dataByte);
static void WriteText(char *str, int x, int y);
static void ClearScreen(void);
static void WriteChar(int idx);
static void CursorOnOff(int onOff, int x, int y);
static void SetPixelOnOff(u8_t x, u8_t y, u8_t onOff);

static const u8_t font[]= 
{        
  0x00, 0x00, 0x00, 0x00, 0x00, 	
  0x00, 0x00, 0x5F, 0x00, 0x00, 	
  0x00, 0x07, 0x00, 0x07, 0x00, 	
  0x14, 0x7F, 0x14, 0x7F, 0x14, 	
  0x24, 0x2A, 0x7F, 0x2A, 0x12, 	
  0x23, 0x13, 0x08, 0x64, 0x62, 	
  0x36, 0x49, 0x56, 0x20, 0x50, 	
  0x00, 0x08, 0x07, 0x03, 0x00, 	
  0x00, 0x1C, 0x22, 0x41, 0x00, 	
  0x00, 0x41, 0x22, 0x1C, 0x00, 	
  0x2A, 0x1C, 0x7F, 0x1C, 0x2A, 	
  0x08, 0x08, 0x3E, 0x08, 0x08, 	
  0x00, 0x80, 0x70, 0x30, 0x00, 	
  0x08, 0x08, 0x08, 0x08, 0x08, 	
  0x00, 0x00, 0x60, 0x60, 0x00, 	
  0x20, 0x10, 0x08, 0x04, 0x02, 	
  0x3E, 0x51, 0x49, 0x45, 0x3E, 	
  0x00, 0x42, 0x7F, 0x40, 0x00, 	
  0x72, 0x49, 0x49, 0x49, 0x46, 	
  0x21, 0x41, 0x49, 0x4D, 0x33, 	
  0x18, 0x14, 0x12, 0x7F, 0x10, 	
  0x27, 0x45, 0x45, 0x45, 0x39, 	
  0x3C, 0x4A, 0x49, 0x49, 0x31, 	
  0x41, 0x21, 0x11, 0x09, 0x07, 	
  0x36, 0x49, 0x49, 0x49, 0x36, 	
  0x46, 0x49, 0x49, 0x29, 0x1E, 	
  0x00, 0x00, 0x14, 0x00, 0x00, 	
  0x00, 0x40, 0x34, 0x00, 0x00, 	
  0x00, 0x08, 0x14, 0x22, 0x41, 	
  0x14, 0x14, 0x14, 0x14, 0x14, 	
  0x00, 0x41, 0x22, 0x14, 0x08, 	
  0x02, 0x01, 0x59, 0x09, 0x06, 	
  0x3E, 0x41, 0x5D, 0x59, 0x4E, 	
  0x7C, 0x12, 0x11, 0x12, 0x7C, 	
  0x7F, 0x49, 0x49, 0x49, 0x36, 	
  0x3E, 0x41, 0x41, 0x41, 0x22, 	
  0x7F, 0x41, 0x41, 0x41, 0x3E, 	
  0x7F, 0x49, 0x49, 0x49, 0x41, 	
  0x7F, 0x09, 0x09, 0x09, 0x01, 	
  0x3E, 0x41, 0x41, 0x51, 0x73, 	
  0x7F, 0x08, 0x08, 0x08, 0x7F, 	
  0x00, 0x41, 0x7F, 0x41, 0x00, 	
  0x20, 0x40, 0x41, 0x3F, 0x01, 	
  0x7F, 0x08, 0x14, 0x22, 0x41, 	
  0x7F, 0x40, 0x40, 0x40, 0x40, 	
  0x7F, 0x02, 0x1C, 0x02, 0x7F, 	
  0x7F, 0x04, 0x08, 0x10, 0x7F, 	
  0x3E, 0x41, 0x41, 0x41, 0x3E, 	
  0x7F, 0x09, 0x09, 0x09, 0x06, 	
  0x3E, 0x41, 0x51, 0x21, 0x5E, 	
  0x7F, 0x09, 0x19, 0x29, 0x46, 	
  0x26, 0x49, 0x49, 0x49, 0x32, 	
  0x01, 0x01, 0x7F, 0x01, 0x01,
  0x3F, 0x40, 0x40, 0x40, 0x3F, 	
  0x1F, 0x20, 0x40, 0x20, 0x1F, 	
  0x3F, 0x40, 0x38, 0x40, 0x3F, 	
  0x63, 0x14, 0x08, 0x14, 0x63, 	
  0x03, 0x04, 0x78, 0x04, 0x03, 	
  0x61, 0x59, 0x49, 0x4D, 0x43, 	
  0x00, 0x7F, 0x41, 0x41, 0x41, 	
  0x02, 0x04, 0x08, 0x10, 0x20, 	
  0x00, 0x41, 0x41, 0x41, 0x7F, 	
  0x04, 0x02, 0x01, 0x02, 0x04, 	
  0x40, 0x40, 0x40, 0x40, 0x40, 	
  0x00, 0x03, 0x07, 0x08, 0x00, 	
  0x20, 0x54, 0x54, 0x78, 0x40, 	
  0x7F, 0x28, 0x44, 0x44, 0x38, 	
  0x38, 0x44, 0x44, 0x44, 0x28, 	
  0x38, 0x44, 0x44, 0x28, 0x7F, 	
  0x38, 0x54, 0x54, 0x54, 0x18, 	
  0x00, 0x08, 0x7E, 0x09, 0x02, 	
  0x18, 0xA4, 0xA4, 0x9C, 0x78, 	
  0x7F, 0x08, 0x04, 0x04, 0x78, 	
  0x00, 0x44, 0x7D, 0x40, 0x00, 	
  0x20, 0x40, 0x40, 0x3D, 0x00, 	
  0x7F, 0x10, 0x28, 0x44, 0x00, 	
  0x00, 0x41, 0x7F, 0x40, 0x00, 	
  0x7C, 0x04, 0x78, 0x04, 0x78, 	
  0x7C, 0x08, 0x04, 0x04, 0x78, 	
  0x38, 0x44, 0x44, 0x44, 0x38, 	
  0xFC, 0x18, 0x24, 0x24, 0x18, 	
  0x18, 0x24, 0x24, 0x18, 0xFC, 	
  0x7C, 0x08, 0x04, 0x04, 0x08, 	
  0x48, 0x54, 0x54, 0x54, 0x24, 	
  0x04, 0x04, 0x3F, 0x44, 0x24, 	
  0x3C, 0x40, 0x40, 0x20, 0x7C, 	
  0x1C, 0x20, 0x40, 0x20, 0x1C, 	
  0x3C, 0x40, 0x30, 0x40, 0x3C, 	
  0x44, 0x28, 0x10, 0x28, 0x44, 	
  0x4C, 0x90, 0x90, 0x90, 0x7C, 	
  0x44, 0x64, 0x54, 0x4C, 0x44, 	
  0x00, 0x08, 0x36, 0x41, 0x00, 	
  0x00, 0x00, 0x77, 0x00, 0x00, 	
  0x00, 0x41, 0x36, 0x08, 0x00
};

/*!
 * @brief Application initialization function
 */
void AppInit(void)
{
}

/*!
 * @brief Main application function
 */
void AppMain(void)
{   
  int x, y;
  
  /* reset OLED controller */
  RST_HIGH();
  SYSTEM_DELAY_MSECS(10);
  RST_LOW();
  SYSTEM_DELAY_MSECS(10);
  RST_HIGH();
  
  WriteCommand(DISPLAYOFF);
  WriteCommand(SETDISPLAYCLOCKDIV);
  WriteCommand(0x80);
  WriteCommand(SETMULTIPLEX);
  WriteCommand(0x1F);
  WriteCommand(SETDISPLAYOFFSET);
  WriteCommand(0x00);
  WriteCommand(SETSTARTLINE | 0x00);
  WriteCommand(CHARGEPUMP);
  WriteCommand(0x14);
  WriteCommand(MEMORYMODE);
  WriteCommand(0x00);
  WriteCommand(SEGREMAP | 0x01);
  WriteCommand(SETLOWCOLUMN | 0x00);
  WriteCommand(SETHIGHCOLUMN | 0x00);
  WriteCommand(SETCONTRAST);
  WriteCommand(0x8F);
  WriteCommand(COMSCANDEC);
  WriteCommand(SETPRECHARGE);
  WriteCommand(0xF1);
  WriteCommand(SETCOMPINS);
  WriteCommand(0x02);
  WriteCommand(SETVCOMDETECT);
  WriteCommand(0x40);
  WriteCommand(DISPLAYALLON_RESUME);
  WriteCommand(NORMALDISPLAY);
  WriteCommand(DISPLAYON);
  
  ClearScreen();

  SetPixelOnOff(0, 0, 1);

           //012345678901234567890
  WriteText("Booting...           ", 0, 0);
  SYSTEM_DELAY_MSECS(3500);
  ClearScreen();
  WriteText("SYSTEM READY         ", 0, 0);
  WriteText("C:\\                 ", 0, 1);
  
  while (1)
  {     
    CursorOnOff(1, 3, 1);
    SYSTEM_DELAY_MSECS(500);
    CursorOnOff(0, 3, 1);
    SYSTEM_DELAY_MSECS(500);
  }
}

static void WriteData(u8_t dataByte)
{
  DC_HIGH();
  CS_LOW();
  WriteByte(dataByte);
  CS_HIGH();
}

static void WriteCommand(u8_t dataByte)
{
  DC_LOW();
  CS_LOW();
  WriteByte(dataByte);
  CS_HIGH();
}

static void WriteByte(u8_t dataByte)
{
  USISRL = dataByte;
  USICNT = 8;
  while (!(USIIFG & USICTL1));
}

static void WriteChar(int idx)
{
  WriteData(font[idx]);
  WriteData(font[idx+1]);
  WriteData(font[idx+2]);
  WriteData(font[idx+3]);
  WriteData(font[idx+4]);
  WriteData(0);
}

static void CursorOnOff(int onOff, int x, int y)
{
  WriteCommand(SETCOLUMNADDR);
  WriteCommand(x*6);
  WriteCommand(127);
  WriteCommand(SETPAGEADDR);
  WriteCommand(y);
  WriteCommand(7);
  WriteData(onOff ? 0x7F: 0x00);
  WriteData(onOff ? 0x7F: 0x00);
  WriteData(onOff ? 0x7F: 0x00);
  WriteData(onOff ? 0x7F: 0x00);
  WriteData(onOff ? 0x7F: 0x00);
  WriteData(0);
}

static void WriteText(char *str, int x, int y)
{
  WriteCommand(SETCOLUMNADDR);
  WriteCommand(x*6);
  WriteCommand(127);
  WriteCommand(SETPAGEADDR);
  WriteCommand(y);
  WriteCommand(7);
  while (*str)
  {
    int ch = *str;
    if (ch < 0x20) ch = 0x20;
    if (ch > 0x7E) ch = 0x20;
    ch -= 0x20;
    ch *= 5;
    WriteChar(ch);
    str++;
    if (x++ >= MAX_COLS) break;
  }
}

static void SetPixelOnOff(u8_t x, u8_t y, u8_t onOff)
{
  WriteCommand(SETCOLUMNADDR);
  WriteCommand(x);
  WriteCommand(127);
  WriteCommand(SETPAGEADDR);
  WriteCommand(y / 8);
  WriteCommand(7);
  WriteData(onOff ? 0x01: 0x00);

}

static void ClearScreen(void)
{
  int i = 1024;
  while (i--)
    WriteData(0);
}
